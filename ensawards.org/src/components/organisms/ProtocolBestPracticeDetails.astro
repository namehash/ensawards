---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import { contractPipeline } from "../../contract-pipelines";
import { daoContractsOnly, defiContractsOnly } from "../../contract-pipelines/filters";
import { sortProtocolLeaderboard } from "../../contract-pipelines/sorting";
import { type BestPracticeProtocol } from "../../types/bestPractices";
import { DAOProtocolId, DefiProtocolId } from "../../types/protocols";
import { getDaoByProtocolId, getDefiProtocolByProtocolId } from "../../utils/dataAccess";
import { markdownToHtml } from "../../utils/markdown";
import { cn } from "../../utils/tailwindClassConcatenation";
import ContractNamingBanner from "../atoms/ContractNamingBanner.astro";
import LeaderboardCard from "../atoms/cards/LeaderboardCard.astro";
import EnscribeIcon from "../atoms/icons/EnscribeIconDark.astro";
import EnscribeIconLight from "../atoms/icons/EnscribeIconLight.astro";
import ItemsList from "../molecules/ItemsList.astro";
import SubpageHero from "../molecules/SubpageHero.astro";
import { shadcnButtonVariants } from "../ui/shadcnButtonStyles";

export interface ProtocolBestPracticeDetailsProps {
  bestPractice: BestPracticeProtocol;
}

const images = import.meta.glob<{ default: ImageMetadata }>("/src/assets/*.{jpeg,jpg,png,gif,svg}");
const placeIcons = [
  "/src/assets/firstPlaceAward.svg",
  "/src/assets/secondPlaceAward.svg",
  "/src/assets/thirdPlaceAward.svg",
];

const { bestPractice }: ProtocolBestPracticeDetailsProps = Astro.props;

const daoScores = contractPipeline({
  filter: daoContractsOnly,
  sort: sortProtocolLeaderboard,
});

const defiScores = contractPipeline({
  filter: defiContractsOnly,
  sort: sortProtocolLeaderboard,
});

const technicalSectionContentStyles = "w-fit text-base font-normal leading-7 text-gray-500";
const technicalSectionMinorHeaderStyles = "text-lg leading-normal font-semibold text-black";
---

<SubpageHero
  header={bestPractice.name}
  description={bestPractice.description}
  breadcrumbs={["ENS best practices", bestPractice.categoryName]}
  additionalElements={[
    {
      name: "Category",
      value: bestPractice.categoryName,
      link: `/ens-best-practices/${bestPractice.categorySlug}`,
    },
  ]}>
  <technical-info-anchor
    data-id={bestPractice.id}
    href={`#${bestPractice.id}-technical-info`}
    id={`${bestPractice.id}-technical-info-anchor`}
    slot="technicalSectionAnchor"
    class="text-white transition-all duration-200 decoration-white/40 hover:decoration-white underline underline-offset-[25%] decoration-from-font hover:cursor-pointer"
    >Learn More</technical-info-anchor
  >
  <div
    slot="extraAdditionalElement"
    class="flex flex-row sm:flex-col flex-nowrap justify-between sm:justify-center items-center sm:items-start sm:gap-0 leading-7 max-sm:self-stretch">
    <p class="text-gray-400">Powered by</p>
    <a href="https://www.enscribe.xyz/" target="_blank" rel="noreferrer"
      ><EnscribeIcon /></a
    >
  </div>
</SubpageHero>
<section
  class="w-full box-border h-fit flex flex-col flex-nowrap justify-center items-center gap-10 py-5 sm:py-[60px] px-5 sm:px-8">
  <ContractNamingBanner />
  <ItemsList header="DAO Leaderboard" containerStyles="gap-3">
    {
      Object.entries(daoScores).map(([scoreCategory, value], idx) => {
        const daoId = scoreCategory as DAOProtocolId;
        const daoProtocol = getDaoByProtocolId(daoId);
        const DaoIcon = daoProtocol.icon;
        return (
          <LeaderboardCard
            key={`dao-leaderboard-card-${daoProtocol.id}`}
            name={daoProtocol.name}
            ensAwardsScore={value}
            viewDetailsLink={`/dao/${daoProtocol.slug}`}
            viewDetailsText="DAO report">
            {idx < 3 ? (
              <Image
                alt={`${idx + 1}-place`}
                src={images[placeIcons[idx]]()}
                slot="placeIcon"
              />
            ) : (
              <p
                slot="placeIcon"
                class="w-8 pt-[7px] px-[11px] pb-[5px] text-sm leading-normal font-semibold text-muted-foreground">
                {idx + 1}
              </p>
            )}
            <DaoIcon slot="appIcon" className="w-10 h-10 rounded-md" />
          </LeaderboardCard>
        );
      })
    }
  </ItemsList>
  <ItemsList header="Defi Leaderboard" containerStyles="gap-3">
    {
      Object.entries(defiScores).map(([scoreCategory, value], idx) => {
        const defiId = scoreCategory as DefiProtocolId;
        const defiProtocol = getDefiProtocolByProtocolId(defiId);
        const DefiIcon = defiProtocol.icon;
        return (
          <LeaderboardCard
            key={`defi-leaderboard-card-${defiProtocol.id}`}
            name={defiProtocol.name}
            ensAwardsScore={value}
            viewDetailsLink={`/defi/${defiProtocol.slug}`}
            viewDetailsText="Defi protocol report">
            {idx < 3 ? (
              <Image
                alt={`${idx + 1}-place`}
                src={images[placeIcons[idx]]()}
                slot="placeIcon"
              />
            ) : (
              <p
                slot="placeIcon"
                class="w-8 pt-[7px] px-[11px] pb-[5px] text-sm leading-normal font-semibold text-muted-foreground">
                {idx + 1}
              </p>
            )}
            <DefiIcon slot="appIcon" className="w-10 h-10 rounded-md" />
          </LeaderboardCard>
        );
      })
    }
  </ItemsList>
</section>
<section
  id={`${bestPractice.id}-technical-info`}
  class="w-full box-border h-fit flex flex-col flex-nowrap justify-start items-center pt-10 sm:pt-6 pb-6 sm:pb-[60px] px-5 sm:px-8">
  <div
    class="w-full max-w-[1216px] flex flex-nowrap flex-row gap-20 justify-center items-start">
    <div
      class="max-w-[716px] flex flex-nowrap flex-col justify-center items-start gap-3">
      <h2 class="text-2xl leading-none font-semibold text-black">
        {bestPractice.technicalDetails.main.header}
      </h2>
      <p
        class={technicalSectionContentStyles}
        set:html={markdownToHtml(bestPractice.technicalDetails.main.content)}
      />
      {
        bestPractice.technicalDetails.sides.map((additionalContent) => (
          <>
            <h3 class={technicalSectionMinorHeaderStyles}>
              {additionalContent.header}
            </h3>
            <p
              class={technicalSectionContentStyles}
              set:html={markdownToHtml(additionalContent.content)}
            />
          </>
        ))
      }
    </div>
    <div
      class="w-1/2 min-w-[300px] max-w-[420px] box-border h-fit hidden sm:flex flex-col flex-nowrap justify-center items-start gap-4 bg-gray-50 rounded-xl py-5 px-6">
      <h4
        class={cn(
          technicalSectionMinorHeaderStyles,
          "flex flex-row justify-start items-center gap-5",
        )}>
        Powered by <EnscribeIconLight />
      </h4>
      <p class={technicalSectionContentStyles}>
        With Enscribe, developers can easily assign ENS names to smart
        contracts.
      </p>
      <div class="bg-gray-200 h-[1px] self-stretch"></div>
      <a
        href="https://www.enscribe.xyz/"
        target="_blank"
        rel="noreferrer"
        class={cn(
          shadcnButtonVariants({
            variant: "secondary",
            size: "default",
            className: "cursor-pointer rounded-full self-stretch",
          }),
        )}>Learn more about Enscribe</a
      >
    </div>
  </div>
</section>
