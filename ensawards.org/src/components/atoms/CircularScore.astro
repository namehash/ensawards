---
import { cn } from "../../utils/tailwindClassConcatenation";
export interface CircularScoreProps {
  score: number;
  size?: number;
  strokeWidth?: number;
}

const { score, size = 139, strokeWidth = 10 }: CircularScoreProps = Astro.props;

const gradientStartColors = ["#12D494", "#ffd230", "#fb2c36"];
const gradientStopColors = ["#0D9A6B", "#e17100", "#c10007"];

const getGradientColorIndex = (score: number) => {
  if (score < 35) {
    // return red-ish gradient index
    return 2;
  }

  if (score < 70) {
    // return orange-ish gradient index
    return 1;
  }

  // return green-ish gradient index
  return 0;
};

const gradientIndex = getGradientColorIndex(score);
const colorFrom = gradientStartColors[gradientIndex];
const colorTo = gradientStopColors[gradientIndex];

// Count size parameters of the score bar
const radius = (size - strokeWidth) / 2;
const circumference = 2 * Math.PI * radius;
---

<div
  class="relative flex items-center justify-center"
  style={`width: ${size}px; height: ${size}px;`}>
  <svg width={size} height={size} class="transform -rotate-90">
    <!-- Background circle -->
    <circle
      stroke="#0D0F28"
      fill="transparent"
      stroke-width="10"
      opacity="0.8"
      r={radius}
      cx={size / 2}
      cy={size / 2}></circle>

    <!-- Gradient -->
    <defs>
      <linearGradient id="gradient" x1="1" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color={colorFrom}></stop>
        <stop offset="100%" stop-color={colorTo}></stop>
      </linearGradient>
    </defs>

    <!-- Foreground progress circle -->
    <circle
      id="progressBar"
      data-radius={radius}
      data-circumference={circumference}
      stroke="url(#gradient)"
      fill="transparent"
      stroke-width={strokeWidth}
      stroke-linecap="round"
      stroke-dasharray={circumference}
      stroke-dashoffset={circumference}
      r={radius}
      cx={size / 2}
      cy={size / 2}
      class="transition-all ease-linear"></circle>
  </svg>
  <div
    class="absolute w-full flex flex-row flex-nowrap justify-center items-start gap-0">
    <p
      id="scoreNumber"
      data-score={score}
      class="text-4xl text-white leading-8 font-semibold transition-all ease-linear">
    </p>
    <p
      class={cn(
        "text-2xl leading-8 text-white/50 font-semibold"
      )}>
      %
    </p>
  </div>
</div>
<script>
  // Set up of the numeric label
  const scoreLabel = document.getElementById("scoreNumber");
  const targetScore = Number(scoreLabel.dataset.score);
  scoreLabel.innerText = "0";
  let counter = 0;

  // Set up of the progress bar
  const progressBar = document.getElementById("progressBar");
  const radius = Number(progressBar.dataset.radius);
  const circumference = Number(progressBar.dataset.circumference);
  let offset = circumference;

  // Initial delay
  let delay = 200;

  function animateScore() {
    // Calculate new values
    counter += 1;
    offset = circumference * (1 - counter / 100);

    // Display new values
    progressBar.setAttribute("stroke-dashoffset", offset.toString());
    scoreLabel.innerText = `${counter}`;

    // Adjust delay and set another timeout if needed
    if (counter !== targetScore) {
      // Delay grows when counter is closer to target
      delay =
        counter > targetScore - 5 ? 40 * (5 - (targetScore - counter)) : 20;

      setTimeout(animateScore, delay);
    }
  }
  if (targetScore > 0) {
    setTimeout(animateScore, delay);
  }
</script>
