---
import { BestPracticeApplications, BestPracticeAppliesTo } from "../../../types/bestPractices";
import {
  calculateAppSupport,
  calculateAppsPassed,
  getBestPracticeById,
} from "../../../utils/dataAccess";
import { getAppSupportColor } from "../../../utils/styles";
import { cn } from "../../../utils/tailwindClassConcatenation";
import { shadcnButtonVariants } from "../../ui/shadcnButtonStyles";
export interface BestPracticeCardProps {
  id: string;
  name: string;
  description: string;
  viewReviewsLink: string;
  appliesTo: BestPracticeAppliesTo[];
}

const { id, name, description, viewReviewsLink, appliesTo }: BestPracticeCardProps = Astro.props;

let appsPassed: number;
let appSupport: number;

// Theoretically, because of Astro's build-time page generation, this best practice should always be defined
const bestPracticeToDisplay = getBestPracticeById(id);

if (appliesTo.includes(BestPracticeApplications.App) && bestPracticeToDisplay !== undefined) {
  appsPassed = calculateAppsPassed(bestPracticeToDisplay);
  appSupport = calculateAppSupport(bestPracticeToDisplay);
}
---

<a
  href={viewReviewsLink}
  class="max-md:w-fit w-[calc(50%-10px)] max-w-[598px] h-fit min-h-[223px] box-border flex flex-col flex-nowrap
            justify-center items-start gap-3 sm:gap-4 p-5 sm:px-6 sm:pt-6 sm:pb-4 rounded-2xl border border-gray-200 hover:border-gray-300 hover:shadow-xs cursor-pointer">
  <div
    class="flex flex-col flex-nowrap justify-center items-start gap-5 self-stretch">
    <slot name="icon" />
    <div
      class="flex flex-col flex-nowrap justify-center items-start gap-3 sm:gap-2 self-stretch">
      <div
        class="w-fit flex flex-nowrap flex-row justify-start items-center gap-3">
        <h3 class="text-lg leading-normal font-semibold text-black">{name}</h3>
        <slot name="badge" />
      </div>
      <p
        class="text-muted-foreground text-sm sm:text-base leading-normal font-normal">
        {description}
      </p>
    </div>
  </div>
  <div class="bg-gray-200 h-[1px] self-stretch"></div>
  <div
    class="flex flex-col-reverse sm:flex-row flex-nowrap justify-center sm:justify-between items-center
                max-sm:gap-3 self-stretch">
    <button
      class={cn(
        shadcnButtonVariants({
          variant: "secondary",
          size: "default",
          className: "cursor-pointer rounded-full max-sm:self-stretch",
        }),
      )}>
      View details
    </button>
    <div
      class="flex flex-nowrap flex-col sm:flex-row justify-start items-center gap-2 sm:gap-6 sm:pl-4 max-sm:self-stretch">
      {
        // TODO: Hacky approach to display this info only for contract-related BPs --> to be refactored later
        name.includes("contract") && (
          <div class="flex flex-row justify-between sm:justify-start items-center sm:gap-2 max-sm:self-stretch">
            <p class="text-sm leading-normal font-normal text-muted-foreground">
              Applies to
            </p>
            <div class="flex flex-row justify-start items-center gap-1">
              {appliesTo.map((bestPracticeApplication) => (
                <span class="flex justify-center items-center px-2 py-[2px] rounded-md bg-secondary text-black text-xs leading-normal font-semibold">
                  {bestPracticeApplication}
                </span>
              ))}
            </div>
          </div>
        )
      }
      {
        // TODO: Hacky approach to not display this info for contract-related BPs --> to be refactored later
        appliesTo.includes(BestPracticeApplications.App) &&
          !name.includes("contract") && (
            <>
              <div class="flex flex-row sm:flex-col flex-nowrap justify-between sm:justify-center items-center sm:items-start sm:gap-0 max-sm:self-stretch">
                <p class="text-muted-foreground text-sm leading-normal font-normal">
                  Apps passed
                </p>
                <p class="text-sm leading-normal font-semibold text-accent-foreground">
                  {appsPassed}
                </p>
              </div>
              <div class="flex flex-row sm:flex-col flex-nowrap justify-between sm:justify-center items-center sm:items-start sm:gap-0 max-sm:self-stretch">
                <p class="text-muted-foreground text-sm leading-normal font-normal">
                  App support
                </p>
                <p
                  class={cn(
                    "text-sm leading-normal font-semibold",
                    `text-${getAppSupportColor(appSupport)}`,
                  )}>
                  {appSupport}%
                </p>
              </div>
            </>
          )
      }
    </div>
  </div>
</a>
