---
import { normalizePhrase, pluralizeBestPracticeTarget } from "../../utils/textModifications";
import type { ImageMetadata } from "astro";
import { ProtocolType, ProtocolTypes } from "../../types/bestPractices";
import DataLoadingError from "../../components/organisms/DataLoadingError.astro";
import { ProtocolId } from "../../types/protocols";
import { getProtocolById, getProtocolTypeBySlug } from "../../utils/dataAccess";
import SubpageHero from "../../components/molecules/SubpageHero.astro";
import Layout from "../../layouts/Layout.astro";
import LeaderboardCard from "../../components/atoms/cards/LeaderboardCard.astro";
import { Image } from "astro:assets";
import ItemsList from "../../components/molecules/ItemsList.astro";
import { getContractNamingScoresByProtocolType } from "../../utils/dataAccess";
import { SupportedGroupByCategory } from "../../contract-pipelines/group-by";

export function getStaticPaths() {
  return Object.values(ProtocolTypes).map((protocolType) => ({
    params: { protocolType: normalizePhrase(protocolType) },
  }));
}

const { protocolType } = Astro.params;

const images = import.meta.glob<{ default: ImageMetadata }>("/src/assets/*.{jpeg,jpg,png,gif,svg}");
const placeIcons = [
  "/src/assets/firstPlaceAward.svg",
  "/src/assets/secondPlaceAward.svg",
  "/src/assets/thirdPlaceAward.svg",
];

const resolvedProtocolType = getProtocolTypeBySlug(protocolType);

// The default values should never be used. Only introduced for type safety.
let normalizedProtocolType = "-";
let pluralizedBestPracticeTarget = "-";
let protocolScores: Record<SupportedGroupByCategory, number> = {};

if (resolvedProtocolType) {
  normalizedProtocolType = normalizePhrase(resolvedProtocolType);
  pluralizedBestPracticeTarget = pluralizeBestPracticeTarget(resolvedProtocolType);
  protocolScores = getContractNamingScoresByProtocolType(resolvedProtocolType);
}
---

{
  resolvedProtocolType === undefined ? (
    // theoretically, because of Astro's build-time page generation, this should never happen
    <DataLoadingError />
  ) : (
    <Layout
      pageMetadata={{
        title: `ENSAwards: ENS Leaderboard for ${resolvedProtocolType} Integrations`,
        description: `See how ${pluralizedBestPracticeTarget} score on ENS integration benchmarks.`,
        url: `https://ensawards.org/leaderboards/${normalizedProtocolType}`,
        ogImage: `https://ensawards.org/${normalizedProtocolType}_leaderboard_og_image.png`,
        twitterImage: `https://ensawards.org/${normalizedProtocolType}_leaderboard_twitter_og_image.png`,
      }}>
      <SubpageHero
        header={`${resolvedProtocolType} leaderboard`}
        description={`Compare ${pluralizedBestPracticeTarget} by their rank of following a selection of ENS best practices.`}
        breadcrumbs={["ENS leaderboards"]}
        customImage={{
          source: "/src/assets/leaderboardsHeroImage.png",
          width: 371,
          height: 372,
          styles: "-top-0 right-0",
        }}
      />
      <section class="w-full box-border h-fit flex flex-col flex-nowrap justify-start items-center max-sm:gap-6 gap-10 p-5 sm:py-[60px] sm:px-8">
        <ItemsList containerStyles="gap-3 sm:gap-3">
          {Object.entries(protocolScores).map(([scoreCategory, value], idx) => {
            const protocolId = scoreCategory as ProtocolId;
            const protocol = getProtocolById(protocolId);
            const ProtocolIcon = protocol.icon;
            return (
              <LeaderboardCard
                key={`${normalizedProtocolType}-leaderboard-card-${protocol.id}`}
                name={protocol.name}
                ensAwardsScore={value}
                viewDetailsLink={`/${normalizedProtocolType}/${protocol.slug}`}
                viewDetailsText={`${resolvedProtocolType}${resolvedProtocolType !== ProtocolTypes.DAO ? " protocol" : ""} report`}>
                {idx < 3 ? (
                  <Image
                    alt={`${idx + 1}-place`}
                    src={images[placeIcons[idx]]()}
                    slot="placeIcon"
                  />
                ) : (
                  <p
                    slot="placeIcon"
                    class="w-8 pt-[7px] px-[11px] pb-[5px] text-sm leading-normal font-semibold text-muted-foreground">
                    {idx + 1}
                  </p>
                )}
                <ProtocolIcon
                  slot="rankedEntityIcon"
                  className="w-10 h-10 rounded-md"
                />
              </LeaderboardCard>
            );
          })}
        </ItemsList>
      </section>
    </Layout>
  )
}
