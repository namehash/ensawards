---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import LeaderboardCard from "../../components/atoms/cards/LeaderboardCard.astro";
import SuggestionCard from "../../components/atoms/cards/SuggestionCard.astro";
import ItemsList from "../../components/molecules/ItemsList.astro";
import SubpageHero from "../../components/molecules/SubpageHero.astro";
import DataLoadingError from "../../components/organisms/DataLoadingError.astro";
import { APPS } from "../../data/apps";
import Layout from "../../layouts/Layout.astro";
import { AppType, AppTypes } from "../../types/apps";
import {
  calculateAppEnsAwardsScore,
  pluralizeBestPracticeApplication,
} from "../../utils/dataAccess";

export function getStaticPaths() {
  return Object.values(AppTypes).map((appType) => ({
    params: { appType: appType.toLowerCase() },
  }));
}

const { appType } = Astro.params;

const images = import.meta.glob<{ default: ImageMetadata }>("/src/assets/*.{jpeg,jpg,png,gif,svg}");
const placeIcons = [
  "/src/assets/firstPlaceAward.svg",
  "/src/assets/secondPlaceAward.svg",
  "/src/assets/thirdPlaceAward.svg",
];

const pathToAppType = new Map<string, AppType>([]);

Object.values(AppTypes).forEach((appType) => pathToAppType.set(appType.toLowerCase(), appType));

const resolvedAppType = pathToAppType.get(appType);
---

{
  resolvedAppType === undefined ? (
    // theoretically, because of Astro's build-time page generation, this should never happen
    <DataLoadingError />
  ) : (
    <Layout
      pageMetadata={{
        title: `ENSAwards: ENS Leaderboard for ${resolvedAppType} Integrations`,
        description: `See how ${pluralizeBestPracticeApplication(resolvedAppType).toLowerCase()} score on ENS integration benchmarks.`,
        url: `https://ensawards.org/leaderboards/${resolvedAppType.toLowerCase()}`,
        ogImage: `https://ensawards.org/${resolvedAppType.toLowerCase()}_leaderboard_og_image.png`,
        twitterImage: `https://ensawards.org/${resolvedAppType.toLowerCase()}_leaderboard_twitter_og_image.png`,
      }}>
      <SubpageHero
        header={`${resolvedAppType} leaderboard`}
        description={`Compare ${pluralizeBestPracticeApplication(resolvedAppType).toLowerCase()} by their rank of following a selection of ENS best practices.`}
        breadcrumbs={["ENS leaderboards"]}
        customImage={{
          source: "/src/assets/leaderboardsHeroImage.png",
          width: 371,
          height: 372,
          styles: "-top-0 right-0",
        }}
      />
      <section class="w-full box-border h-fit flex flex-col flex-nowrap justify-start items-center max-sm:gap-6 gap-10 p-5 sm:py-[60px] sm:px-8">
        <ItemsList containerStyles="gap-3 sm:gap-3">
          {APPS.filter((app) => app.type === resolvedAppType)
            .sort(
              (a, b) =>
                calculateAppEnsAwardsScore(b) - calculateAppEnsAwardsScore(a),
            )
            .map((app, idx) => (
              <LeaderboardCard
                key={`app-review-card-${app.id}`}
                name={app.name}
                ensAwardsScore={calculateAppEnsAwardsScore(app)}
                viewDetailsLink={`/app/${app.slug}`}
                viewDetailsText="App report">
                <Image
                  src={images[app.iconPath]()}
                  alt={`${app.id}`}
                  slot="appIcon"
                  class="w-10 h-10 rounded-md"
                />
                {idx < 3 ? (
                  <Image
                    alt={`${idx + 1}-place`}
                    src={images[placeIcons[idx]]()}
                    slot="placeIcon"
                  />
                ) : (
                  <p
                    slot="placeIcon"
                    class="w-8 pt-[7px] px-[11px] pb-[5px] text-sm leading-normal font-semibold text-muted-foreground">
                    {idx + 1}
                  </p>
                )}
              </LeaderboardCard>
            ))}
          <SuggestionCard whatsSuggested="app" />
        </ItemsList>
      </section>
    </Layout>
  )
}
