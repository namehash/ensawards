---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import LeaderboardCard from "../../components/atoms/cards/LeaderboardCard.astro";
import SuggestionCard from "../../components/atoms/cards/SuggestionCard.astro";
import ItemsList from "../../components/molecules/ItemsList.astro";
import SubpageHero from "../../components/molecules/SubpageHero.astro";
import DataLoadingError from "../../components/organisms/DataLoadingError.astro";
import { APPS } from "../../data/apps";
import Layout from "../../layouts/Layout.astro";
import { AppTypes } from "../../types/apps";
import { calculateAppEnsAwardsScore, getAppTypeBySlug } from "../../utils/dataAccess";
import { pluralizeBestPracticeTarget } from "../../utils/textModifications";

export function getStaticPaths() {
  return Object.values(AppTypes).map((appType) => ({
    params: { appType: appType.toLowerCase() },
  }));
}

const { appType } = Astro.params;

const images = import.meta.glob<{ default: ImageMetadata }>("/src/assets/*.{jpeg,jpg,png,gif,svg}");
const placeIcons = [
  "/src/assets/firstPlaceAward.svg",
  "/src/assets/secondPlaceAward.svg",
  "/src/assets/thirdPlaceAward.svg",
];

const resolvedAppType = getAppTypeBySlug(appType);

// The fallbacks should never be used. Only introduced for type safety.
const normalizedAppType = resolvedAppType ? resolvedAppType.toLowerCase() : "-";
const pluralizedBestPracticeTarget = resolvedAppType
  ? pluralizeBestPracticeTarget(resolvedAppType).toLowerCase()
  : "-";
---

{
  resolvedAppType === undefined ? (
    // theoretically, because of Astro's build-time page generation, this should never happen
    <DataLoadingError />
  ) : (
    <Layout
      pageMetadata={{
        title: `ENSAwards: ENS Leaderboard for ${resolvedAppType} Integrations`,
        description: `See how ${pluralizedBestPracticeTarget} score on ENS integration benchmarks.`,
        url: `https://ensawards.org/leaderboards/${normalizedAppType}`,
        ogImage: `https://ensawards.org/${normalizedAppType}_leaderboard_og_image.png`,
        twitterImage: `https://ensawards.org/${normalizedAppType}_leaderboard_twitter_og_image.png`,
      }}>
      <SubpageHero
        header={`${resolvedAppType} leaderboard`}
        description={`Compare ${pluralizedBestPracticeTarget} by their rank of following a selection of ENS best practices.`}
        breadcrumbs={["ENS leaderboards"]}
        customImage={{
          source: "/src/assets/leaderboardsHeroImage.png",
          width: 371,
          height: 372,
          styles: "-top-0 right-0",
        }}
      />
      <section class="w-full box-border h-fit flex flex-col flex-nowrap justify-start items-center max-sm:gap-6 gap-10 p-5 sm:py-[60px] sm:px-8">
        <ItemsList containerStyles="gap-3 sm:gap-3">
          {APPS.filter((app) => app.type === resolvedAppType)
            .sort(
              (a, b) =>
                calculateAppEnsAwardsScore(b) - calculateAppEnsAwardsScore(a),
            )
            .map((app, idx) => {
              const AppIcon = app.icon;
              return (
                <LeaderboardCard
                  key={`app-review-card-${app.id}`}
                  name={app.name}
                  ensAwardsScore={calculateAppEnsAwardsScore(app)}
                  viewDetailsLink={`/app/${app.slug}`}
                  viewDetailsText="App report">
                  <AppIcon
                    slot="rankedEntityIcon"
                    className="w-10 h-10 rounded-md"
                  />
                  {idx < 3 ? (
                    <Image
                      alt={`${idx + 1}-place`}
                      src={images[placeIcons[idx]]()}
                      slot="placeIcon"
                    />
                  ) : (
                    <p
                      slot="placeIcon"
                      class="w-8 pt-[7px] px-[11px] pb-[5px] text-sm leading-normal font-semibold text-muted-foreground">
                      {idx + 1}
                    </p>
                  )}
                </LeaderboardCard>
              );
            })}
          <SuggestionCard whatsSuggested="app" />
        </ItemsList>
      </section>
    </Layout>
  )
}
