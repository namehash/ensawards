---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import ContractNamingBanner from "../components/atoms/ContractNamingBanner.astro";
import CategoryCard from "../components/atoms/cards/CategoryCard.astro";
import LeaderboardCard from "../components/atoms/cards/LeaderboardCard.astro";
import SuggestionCard from "../components/atoms/cards/SuggestionCard.astro";
import Hero from "../components/molecules/Hero.astro";
import ItemsList from "../components/molecules/ItemsList.astro";
import { ReferrerLeaderboardSnippet } from "../components/referral-awards-program/referrers/ReferrerLeaderboardSnippet";
import { shadcnButtonVariants } from "../components/ui/shadcnButtonStyles";
import { APPS } from "../data/apps";
import Layout from "../layouts/Layout.astro";
import { AppTypes } from "../types/apps";
import { ProtocolId } from "../types/protocols";
import {
  calculateAppEnsAwardsScore,
  getContractNamingScoresByProtocolType,
  getProtocolById,
} from "../utils/dataAccess";
import { cn } from "../utils/tailwindClassConcatenation";
import { ProtocolTypes } from "../types/bestPractices";
import { normalizePhrase, pluralizeBestPracticeTarget } from "../utils/textModifications";

const images = import.meta.glob<{ default: ImageMetadata }>("/src/assets/*.{jpeg,jpg,png,gif,svg}");
const placeIcons = [
  "/src/assets/firstPlaceAward.svg",
  "/src/assets/secondPlaceAward.svg",
  "/src/assets/thirdPlaceAward.svg",
];
---

<Layout>
  <Hero />
  <section
    id="previews-section"
    class="w-full box-border h-fit flex flex-col flex-nowrap justify-center items-center max-sm:gap-6 gap-10 py-5 sm:py-[60px] px-5 sm:px-8">
    <ContractNamingBanner />
    {
      Object.values(AppTypes).map((appType) => {
        const relevantApps = APPS.filter((app) => app.type === appType);
        const rankedApps = relevantApps
          .map((app) => ({ app, score: calculateAppEnsAwardsScore(app) }))
          .sort((a, b) => b.score - a.score)
          .slice(0, 3);

        return (
          <ItemsList
            header={`Top ${pluralizeBestPracticeTarget(appType)}`}
            containerStyles="gap-3 sm:gap-2 sm:justify-start max-sm:justify-center">
            {rankedApps.map(({ app, score }, idx) => {
              const AppIcon = app.icon;
              return (
                <LeaderboardCard
                  key={`${appType.toLowerCase()}-review-card-${app.id}`}
                  name={app.name}
                  ensAwardsScore={score}
                  viewDetailsLink={`/app/${app.slug}`}
                  viewDetailsText={`${appType} report`}>
                  <AppIcon
                    slot="rankedEntityIcon"
                    className="w-10 h-10 rounded-md"
                  />
                  <Image
                    alt={`${idx + 1}-place`}
                    src={images[placeIcons[idx]]()}
                    slot="placeIcon"
                  />
                </LeaderboardCard>
              );
            })}
            <a
              href={`/leaderboards/${appType.toLowerCase()}`}
              class={cn(
                shadcnButtonVariants({
                  variant: "ghost",
                  size: "default",
                  className:
                    "cursor-pointer rounded-full text-sm max-sm:w-full",
                }),
              )}>
              View full {appType.toLowerCase()} leaderboard
            </a>
          </ItemsList>
        );
      })
    }
    {
      Object.values(ProtocolTypes).map((protocolType) => {
        const protocolScores =
          getContractNamingScoresByProtocolType(protocolType);
        const protocolPathParameter = normalizePhrase(protocolType);

        return (
          <ItemsList
            header={`Top ${pluralizeBestPracticeTarget(protocolType)}`}
            containerStyles="gap-3 sm:gap-2 sm:justify-start max-sm:justify-center">
            {Object.entries(protocolScores)
              .slice(0, 3)
              .map(([scoreCategory, value], idx) => {
                const protocolId = scoreCategory as ProtocolId;
                const protocol = getProtocolById(protocolId);
                const ProtocolIcon = protocol.icon;
                return (
                  <LeaderboardCard
                    key={`${protocolPathParameter}-leaderboard-card-${protocol.id}`}
                    name={protocol.name}
                    ensAwardsScore={value}
                    viewDetailsLink={`/${protocolPathParameter}/${protocol.slug}`}
                    viewDetailsText={`${protocolType}${protocolType !== ProtocolTypes.DAO ? " protocol" : ""} report`}>
                    <Image
                      alt={`${idx + 1}-place`}
                      src={images[placeIcons[idx]]()}
                      slot="placeIcon"
                    />
                    <ProtocolIcon
                      slot="rankedEntityIcon"
                      className="w-10 h-10 rounded-md"
                    />
                  </LeaderboardCard>
                );
              })}
            <a
              href={`/leaderboards/${protocolPathParameter}`}
              class={cn(
                shadcnButtonVariants({
                  variant: "ghost",
                  size: "default",
                  className:
                    "cursor-pointer rounded-full text-sm max-sm:w-full",
                }),
              )}>
              View full {protocolType} leaderboard
            </a>
          </ItemsList>
        );
      })
    }
    <ReferrerLeaderboardSnippet client:load header="Top Referrers" />
  </section>
</Layout>
