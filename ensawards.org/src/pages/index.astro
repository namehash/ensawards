---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import ContractNamingBanner from "../components/atoms/ContractNamingBanner.astro";
import CategoryCard from "../components/atoms/cards/CategoryCard.astro";
import LeaderboardCard from "../components/atoms/cards/LeaderboardCard.astro";
import SuggestionCard from "../components/atoms/cards/SuggestionCard.astro";
import Hero from "../components/molecules/Hero.astro";
import ItemsList from "../components/molecules/ItemsList.astro";
import { ReferrerLeaderboardSnippet } from "../components/referral-awards-program/referrers/ReferrerLeaderboardSnippet";
import { shadcnButtonVariants } from "../components/ui/shadcnButtonStyles";
import { contractPipeline } from "../contract-pipelines";
import { daoContractsOnly } from "../contract-pipelines/filters";
import { sortDaoLeaderboard } from "../contract-pipelines/sorting";
import { APPS } from "../data/apps";
import { BEST_PRACTICE_CATEGORIES } from "../data/bestPractices";
import Layout from "../layouts/Layout.astro";
import { AppTypes } from "../types/apps";
import { OrgId } from "../types/organizations";
import {
  calculateAppEnsAwardsScore,
  getOrgById,
  pluralizeBestPracticeApplication,
} from "../utils/dataAccess";
import { cn } from "../utils/tailwindClassConcatenation";

const images = import.meta.glob<{ default: ImageMetadata }>("/src/assets/*.{jpeg,jpg,png,gif,svg}");
const placeIcons = [
  "/src/assets/firstPlaceAward.svg",
  "/src/assets/secondPlaceAward.svg",
  "/src/assets/thirdPlaceAward.svg",
];

const daoScores = contractPipeline({
  filter: daoContractsOnly,
  sort: sortDaoLeaderboard,
});
---

<Layout>
  <Hero />
  <section
    id="previews-section"
    class="w-full box-border h-fit flex flex-col flex-nowrap justify-center items-center max-sm:gap-6 gap-10 py-5 sm:py-[60px] px-5 sm:px-8">
    <ContractNamingBanner />
    {
      Object.values(AppTypes).map((appType) => {
        const relevantApps = APPS.filter((app) => app.type === appType);
        const rankedApps = relevantApps
          .map((app) => ({ app, score: calculateAppEnsAwardsScore(app) }))
          .sort((a, b) => b.score - a.score)
          .slice(0, 3);

        return (
          <ItemsList
            header={`Top ${pluralizeBestPracticeApplication(appType)}`}
            containerStyles="gap-3 sm:gap-2 sm:justify-start max-sm:justify-center">
            {rankedApps.map(({ app, score }, idx) => (
              <LeaderboardCard
                key={`${appType.toLowerCase()}-review-card-${app.id}`}
                name={app.name}
                ensAwardsScore={score}
                viewDetailsLink={`/app/${app.slug}`}
                viewDetailsText={`${appType} report`}>
                <Image
                  src={images[app.iconPath]()}
                  alt={`${app.id}`}
                  slot="appIcon"
                  class="w-10 h-10 rounded-md"
                />
                <Image
                  alt={`${idx + 1}-place`}
                  src={images[placeIcons[idx]]()}
                  slot="placeIcon"
                />
              </LeaderboardCard>
            ))}
            <a
              href={`/leaderboards/${appType.toLowerCase()}`}
              class={cn(
                shadcnButtonVariants({
                  variant: "ghost",
                  size: "default",
                  className:
                    "cursor-pointer rounded-full text-sm max-sm:w-full",
                }),
              )}>
              View full {appType.toLowerCase()} leaderboard
            </a>
          </ItemsList>
        );
      })
    }
    <ItemsList
      header="Top DAOs"
      containerStyles="gap-3 sm:gap-2 sm:justify-start max-sm:justify-center">
      {
        Object.entries(daoScores)
          .slice(0, 3)
          .map(([scoreCategory, value], idx) => {
            const daoId = scoreCategory as OrgId;
            const org = getOrgById(daoId);
            const OrgIcon = org.icon;
            return (
              <LeaderboardCard
                key={`dao-leaderboard-card-${org.id}`}
                name={org.name}
                ensAwardsScore={value}
                viewDetailsLink={`/dao/${org.slug}`}
                viewDetailsText="DAO report">
                <Image
                  alt={`${idx + 1}-place`}
                  src={images[placeIcons[idx]]()}
                  slot="placeIcon"
                />
                <OrgIcon slot="appIcon" className="w-10 h-10 rounded-md" />
              </LeaderboardCard>
            );
          })
      }
      <a
        href="/leaderboards/dao"
        class={cn(
          shadcnButtonVariants({
            variant: "ghost",
            size: "default",
            className: "cursor-pointer rounded-full text-sm max-sm:w-full",
          }),
        )}>
        View full DAO leaderboard
      </a>
    </ItemsList>
    <ReferrerLeaderboardSnippet client:load header="Top Referrers" />
  </section>
</Layout>
