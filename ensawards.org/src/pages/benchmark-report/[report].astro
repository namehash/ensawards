---
import { getCollection, type CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import { AuthorDisplay } from "../../components/atoms/AuthorDisplay";
import { BenchmarkResultBadge } from "../../components/atoms/badges/BenchmarkResultBadge";
import SuggestionCard from "../../components/atoms/cards/SuggestionCard.astro";
import { EnsSolidIcon } from "../../components/atoms/icons/EnsSolidIcon";
import GlobeIcon from "../../components/atoms/icons/GlobeIcon.astro";
import TwitterIcon from "../../components/atoms/icons/TwitterIcon.astro";
import SubpageHero from "../../components/molecules/SubpageHero.astro";
import DataLoadingError from "../../components/organisms/DataLoadingError.astro";
import { APPS } from "../../data/apps";
import { benchmarkers } from "../../data/benchmarkers";
import Layout from "../../layouts/Layout.astro";
import { BenchmarkResultToBadgeStyles } from "../../utils/styles";

export async function getStaticPaths() {
  const reports = await getCollection("benchmark-reports");
  return reports.map((report: CollectionEntry<"benchmark-reports">) => ({
    params: { report: report.slug },
    props: { report },
  }));
}

type Props = {
  report: CollectionEntry<"benchmark-reports">;
};

const { report: reportEntry } = Astro.props;
const { Content } = await reportEntry.render();
const { data: frontmatter } = reportEntry;

const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/**/*.{jpeg,jpg,png,gif,svg}",
);

// Find the app and benchmark data using the slugs from frontmatter
const app = APPS.find((a) => a.slug === frontmatter.appSlug);
const benchmark = app?.benchmarks.find((b) => b.bestPractice.slug === frontmatter.bestPracticeSlug);

// Get author from benchmarkers
const author = benchmarkers[frontmatter.authorSlug as keyof typeof benchmarkers];

// Check if we have all required data
const hasRequiredData = app && benchmark && author;

// Helper function to format timestamp
function formatTimestamp(timestamp: number): string {
  return new Date(timestamp * 1000).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}
---

{
  !hasRequiredData ? (
    <DataLoadingError />
  ) : (
    <Layout
      pageMetadata={{
        title: frontmatter.title,
        description: frontmatter.description,
        url: `https://ensawards.org/benchmark-report/${reportEntry.slug}`,
        ogImage: frontmatter.ogImagePath,
        twitterImage: frontmatter.twitterOgImagePath,
      }}>

      <SubpageHero
        header={`${app.name} - ${benchmark.bestPractice.name}`}
        description={benchmark.bestPractice.description}
        breadcrumbs={["ENS leaderboards", "App leaderboard", app.name, "Benchmark report"]}>
        <Image
          src={images[app.iconPath]()}
          alt={`${app.id}-icon`}
          slot="icon"
          class="w-[60px] h-[60px] shrink-0 rounded-lg"
        />

        <div
          slot="socialLinks"
          class="flex flex-row flex-nowrap justify-start items-center gap-2">
          <a
            href={app.socials.website}
            rel="noreferrer"
            target="_blank">
            <GlobeIcon className="hover:text-white text-gray-400 transition-all duration-200" />
          </a>
          <a
            href={app.socials.twitter}
            rel="noreferrer"
            target="_blank">
            <TwitterIcon className="hover:text-white text-gray-400 transition-all duration-200" />
          </a>
          {app.socials.ens &&
            <a
              href=`https://app.ens.domains/${encodeURIComponent(app.socials.ens)}`
              rel="noreferrer"
              target="_blank"
            >
              <EnsSolidIcon width={24} height={24} className="hover:text-white text-gray-400 transition-all duration-200"/>
            </a>
          }
        </div>


      </SubpageHero>

      <!-- Report Content - 2 Column Layout -->
      <section class="w-full box-border h-fit flex flex-col flex-nowrap justify-start items-center pt-10 sm:pt-6 pb-6 sm:pb-[60px] px-5 sm:px-8">
        <div class="w-full max-w-[1216px] flex flex-nowrap flex-row gap-20 justify-center items-start">
          <!-- Left Column - Report Content -->
          <div class="max-w-[716px] flex flex-nowrap flex-col justify-center items-start gap-8">
            <!-- Markdown Content -->
            <div class="prose prose-base prose-p:text-gray-500 font-normal prose-g max-w-none">
              <Content />
            </div>
          </div>

          <!-- Right Column - Report Details Sidebar -->
          <div class="w-1/2 min-w-[300px] max-w-[420px] box-border h-fit hidden lg:flex flex-col flex-nowrap justify-center items-start gap-6 bg-gray-50 rounded-xl py-6 px-6">
            <h2 class="text-xl leading-none font-semibold text-black">
              Report Details
            </h2>

            <div class="flex flex-col gap-6 w-full">
              <div class="flex flex-col gap-1">
                <span class="text-sm leading-normal font-normal text-muted-foreground">Category:</span>
                <a
                  href={`/ens-best-practices/${benchmark.bestPractice.categorySlug}`}
                  class="text-sm leading-normal font-medium text-blue-600 hover:text-blue-700 hover:underline underline-offset-[25%] w-fit"
                >
                  {benchmark.bestPractice.categoryName}
                </a>
              </div>

              <div class="flex flex-col gap-1">
                <span class="text-sm leading-normal font-normal text-muted-foreground">Best Practice:</span>
                <a
                  href={`/ens-best-practices/${benchmark.bestPractice.categorySlug}/${benchmark.bestPractice.slug}`}
                  class="text-sm leading-normal font-medium text-blue-600 hover:text-blue-700 hover:underline underline-offset-[25%] w-fit"
                >
                  {benchmark.bestPractice.name}
                </a>
              </div>

              <div class="flex flex-col gap-1">
                <span class="text-sm leading-normal font-normal text-muted-foreground">App Tested:</span>
                <a
                  href={`/app/${app.slug}`}
                  class="text-sm leading-normal font-medium text-blue-600 hover:text-blue-700 hover:underline underline-offset-[25%] w-fit"
                >
                  {app.name}
                </a>
              </div>

              <div class="flex flex-col gap-1">
                <span class="text-sm leading-normal font-normal text-muted-foreground">App Result:</span>
                <BenchmarkResultBadge
                  className={BenchmarkResultToBadgeStyles.get(benchmark.result)}
                  benchmark={benchmark}
                  client:load
                />
              </div>

              <div class="flex flex-col gap-1">
                <span class="text-sm leading-normal font-normal text-muted-foreground">Author:</span>
                <AuthorDisplay
                  author={author}
                  className="text-sm leading-normal font-medium text-blue-600 hover:text-blue-700"
                  client:load
                />
              </div>

              <div class="flex flex-col gap-1">
                <span class="text-sm leading-normal font-normal text-muted-foreground">Report Date:</span>
                <span class="text-sm leading-normal font-medium text-black">
                  {formatTimestamp(frontmatter.createdAt)}
                </span>
              </div>
            </div>

            <!-- Suggestion Card -->
            <div class="w-full mt-2">
              <SuggestionCard layout="column" whatsSuggested="benchmark result" />
            </div>
          </div>
        </div>

        <!-- Mobile Report Details - Full Width -->
        <div class="w-full max-w-[1216px] flex lg:hidden flex-col justify-center items-start gap-6 mt-12 p-6 bg-gray-50 rounded-xl">
          <h2 class="text-xl leading-none font-semibold text-black">
            Report Details
          </h2>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 w-full">
            <div class="flex flex-col gap-1">
              <span class="text-sm leading-normal font-normal text-muted-foreground">Category:</span>
              <a
                href={`/ens-best-practices/${benchmark.bestPractice.categorySlug}`}
                class="text-sm leading-normal font-medium text-blue-600 hover:text-blue-700 hover:underline underline-offset-[25%] w-fit"
              >
                {benchmark.bestPractice.categoryName}
              </a>
            </div>

            <div class="flex flex-col gap-1">
              <span class="text-sm leading-normal font-normal text-muted-foreground">Best Practice:</span>
              <a
                href={`/ens-best-practices/${benchmark.bestPractice.categorySlug}/${benchmark.bestPractice.slug}`}
                class="text-sm leading-normal font-medium text-blue-600 hover:text-blue-700 hover:underline underline-offset-[25%] w-fit"
              >
                {benchmark.bestPractice.name}
              </a>
            </div>

            <div class="flex flex-col gap-1">
              <span class="text-sm leading-normal font-normal text-muted-foreground">App Tested:</span>
              <a
                href={`/app/${app.slug}`}
                class="text-sm leading-normal font-medium text-blue-600 hover:text-blue-700 hover:underline underline-offset-[25%] w-fit"
              >
                {app.name}
              </a>
            </div>

            <div class="flex flex-col gap-1">
              <span class="text-sm leading-normal font-normal text-muted-foreground">App Result:</span>
              <BenchmarkResultBadge
                className={BenchmarkResultToBadgeStyles.get(benchmark.result)}
                benchmark={benchmark}
                client:load
              />
            </div>

            <div class="flex flex-col gap-1">
              <span class="text-sm leading-normal font-normal text-muted-foreground">Author:</span>
              <AuthorDisplay
                author={author}
                className="text-sm leading-normal font-medium text-blue-600 hover:text-blue-700"
                client:load
              />
            </div>

            <div class="flex flex-col gap-1">
              <span class="text-sm leading-normal font-normal text-muted-foreground">Report Date:</span>
              <span class="text-sm leading-normal font-medium text-black">
                {formatTimestamp(frontmatter.createdAt)}
              </span>
            </div>
          </div>

          <!-- Mobile Suggestion Card -->
          <div class="w-full mt-4">
            <SuggestionCard whatsSuggested="benchmark result" />
          </div>
        </div>
      </section>
    </Layout>
  )
}
